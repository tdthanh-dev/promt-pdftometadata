"""
Chatbot Storage Manager - Qu·∫£n l√Ω l∆∞u tr·ªØ d·ªØ li·ªáu cho chatbot
S·ª≠ d·ª•ng SQLite l√†m ch√≠nh + JSON backup
"""

import sqlite3
import json
from datetime import datetime
from pathlib import Path


class ChatbotStorage:
    """Qu·∫£n l√Ω storage cho chatbot - SQLite + JSON backup"""
    
    def __init__(self, db_path='output/documents.db', 
                 json_backup='output/all_documents.json'):
        self.db_path = db_path
        self.json_backup = json_backup
        self._ensure_db_exists()
    
    def _ensure_db_exists(self):
        """ƒê·∫£m b·∫£o database v√† b·∫£ng t·ªìn t·∫°i"""
        if not Path(self.db_path).exists():
            print(f"‚ö†Ô∏è Database ch∆∞a t·ªìn t·∫°i: {self.db_path}")
            print(f"   Ch·∫°y: python batch_processor.py ƒë·ªÉ t·∫°o d·ªØ li·ªáu")
    
    # ========== QUERY & SEARCH ==========
    
    def search_by_keyword(self, keyword):
        """T√¨m ki·∫øm vƒÉn b·∫£n theo t·ª´ kh√≥a trong ti√™u ƒë·ªÅ ho·∫∑c tr√≠ch y·∫øu"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, trich_yeu, ngay_ban_hanh, don_vi_ban_hanh
            FROM thong_bao 
            WHERE tieu_de LIKE ? OR trich_yeu LIKE ?
            ORDER BY ngay_ban_hanh DESC
        """, (f'%{keyword}%', f'%{keyword}%'))
        
        results = cursor.fetchall()
        conn.close()
        
        return results
    
    def search_full_text(self, keyword):
        """T√¨m ki·∫øm trong to√†n b·ªô n·ªôi dung vƒÉn b·∫£n"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, ngay_ban_hanh
            FROM thong_bao 
            WHERE noi_dung_thuan_text LIKE ?
            ORDER BY ngay_ban_hanh DESC
        """, (f'%{keyword}%',))
        
        results = cursor.fetchall()
        conn.close()
        
        return results
    
    def get_by_date_range(self, start_date, end_date):
        """L·∫•y vƒÉn b·∫£n theo kho·∫£ng th·ªùi gian"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, ngay_ban_hanh, don_vi_ban_hanh
            FROM thong_bao 
            WHERE ngay_ban_hanh BETWEEN ? AND ?
            ORDER BY ngay_ban_hanh DESC
        """, (start_date, end_date))
        
        results = cursor.fetchall()
        conn.close()
        
        return results
    
    def get_by_unit(self, don_vi):
        """L·∫•y vƒÉn b·∫£n theo ƒë∆°n v·ªã ban h√†nh"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, ngay_ban_hanh
            FROM thong_bao 
            WHERE don_vi_ban_hanh LIKE ?
            ORDER BY ngay_ban_hanh DESC
        """, (f'%{don_vi}%',))
        
        results = cursor.fetchall()
        conn.close()
        
        return results
    
    def get_document_by_id(self, doc_id):
        """L·∫•y chi ti·∫øt vƒÉn b·∫£n theo ID"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("SELECT * FROM thong_bao WHERE id = ?", (doc_id,))
        result = cursor.fetchone()
        
        if result:
            columns = [desc[0] for desc in cursor.description]
            doc = dict(zip(columns, result))
            
            # Parse JSON fields
            if doc.get('noi_dung_quan_trong'):
                doc['noi_dung_quan_trong'] = json.loads(doc['noi_dung_quan_trong'])
        else:
            doc = None
        
        conn.close()
        return doc
    
    # ========== STATISTICS ==========
    
    def get_statistics(self):
        """Th·ªëng k√™ t·ªïng quan"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # T·ªïng s·ªë vƒÉn b·∫£n
        cursor.execute("SELECT COUNT(*) FROM thong_bao")
        total = cursor.fetchone()[0]
        
        # Theo ƒë∆°n v·ªã
        cursor.execute("""
            SELECT don_vi_ban_hanh, COUNT(*) as count
            FROM thong_bao 
            GROUP BY don_vi_ban_hanh
            ORDER BY count DESC
        """)
        by_unit = cursor.fetchall()
        
        # Theo nƒÉm
        cursor.execute("""
            SELECT substr(ngay_ban_hanh, 1, 4) as year, COUNT(*) as count
            FROM thong_bao 
            GROUP BY year
            ORDER BY year DESC
        """)
        by_year = cursor.fetchall()
        
        conn.close()
        
        return {
            'total': total,
            'by_unit': by_unit,
            'by_year': by_year
        }
    
    def get_recent_documents(self, limit=10):
        """L·∫•y c√°c vƒÉn b·∫£n m·ªõi nh·∫•t"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, ngay_ban_hanh
            FROM thong_bao 
            ORDER BY ngay_ban_hanh DESC
            LIMIT ?
        """, (limit,))
        
        results = cursor.fetchall()
        conn.close()
        
        return results
    
    # ========== BACKUP & EXPORT ==========
    
    def backup_to_json(self):
        """Backup SQLite sang JSON"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("SELECT * FROM thong_bao")
        rows = cursor.fetchall()
        
        # Chuy·ªÉn sang dict
        documents = []
        columns = [desc[0] for desc in cursor.description]
        
        for row in rows:
            doc = dict(zip(columns, row))
            # Parse JSON strings
            if doc.get('noi_dung_quan_trong'):
                try:
                    doc['noi_dung_quan_trong'] = json.loads(doc['noi_dung_quan_trong'])
                except:
                    pass
            # Kh√¥ng l∆∞u vector_data v√†o JSON (qu√° l·ªõn)
            doc.pop('vector_data', None)
            documents.append(doc)
        
        # L∆∞u JSON
        output = {
            'metadata': {
                'total_documents': len(documents),
                'backup_at': datetime.now().isoformat(),
                'source': 'SQLite database'
            },
            'documents': documents
        }
        
        with open(self.json_backup, 'w', encoding='utf-8') as f:
            json.dump(output, f, ensure_ascii=False, indent=2)
        
        conn.close()
        
        file_size = Path(self.json_backup).stat().st_size / 1024  # KB
        print(f"‚úÖ ƒê√£ backup {len(documents)} documents sang {self.json_backup}")
        print(f"üì¶ K√≠ch th∆∞·ªõc: {file_size:.2f} KB")
        
        return len(documents)
    
    def export_to_csv(self, output_file='output/documents.csv'):
        """Export d·ªØ li·ªáu ra CSV"""
        import csv
        
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, file_name, tieu_de, ngay_ban_hanh, 
                   don_vi_ban_hanh, trich_yeu
            FROM thong_bao
        """)
        
        rows = cursor.fetchall()
        columns = [desc[0] for desc in cursor.description]
        
        with open(output_file, 'w', encoding='utf-8-sig', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(columns)
            writer.writerows(rows)
        
        conn.close()
        print(f"‚úÖ ƒê√£ export {len(rows)} documents sang {output_file}")


# ========== DEMO USAGE ==========

def demo_search():
    """Demo t√¨m ki·∫øm"""
    storage = ChatbotStorage()
    
    print("="*70)
    print("üîç DEMO T√åM KI·∫æM")
    print("="*70)
    
    # 1. T√¨m theo t·ª´ kh√≥a
    print("\nüìå T√¨m ki·∫øm: 'h·ªçc ph√≠'")
    results = storage.search_by_keyword('h·ªçc ph√≠')
    
    if results:
        for r in results:
            print(f"\n   ID: {r[0]}")
            print(f"   üìÑ Ti√™u ƒë·ªÅ: {r[2][:70]}...")
            print(f"   üìÖ Ng√†y: {r[4]}")
            print(f"   üè¢ ƒê∆°n v·ªã: {r[5]}")
    else:
        print("   ‚ùå Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£")
    
    # 2. T√¨m theo kho·∫£ng th·ªùi gian
    print(f"\nüìå VƒÉn b·∫£n t·ª´ 2025-01-01 ƒë·∫øn 2025-12-31:")
    results = storage.get_by_date_range('2025-01-01', '2025-12-31')
    print(f"   T√¨m th·∫•y: {len(results)} k·∫øt qu·∫£")
    
    # 3. VƒÉn b·∫£n m·ªõi nh·∫•t
    print(f"\nüìå 5 vƒÉn b·∫£n m·ªõi nh·∫•t:")
    results = storage.get_recent_documents(5)
    for i, r in enumerate(results, 1):
        print(f"   {i}. {r[2][:60]}... ({r[3]})")


def demo_statistics():
    """Demo th·ªëng k√™"""
    storage = ChatbotStorage()
    
    print("\n" + "="*70)
    print("üìä DEMO TH·ªêNG K√ä")
    print("="*70)
    
    stats = storage.get_statistics()
    
    print(f"\nüìà T·ªïng quan:")
    print(f"   T·ªïng s·ªë vƒÉn b·∫£n: {stats['total']}")
    
    print(f"\nüè¢ Theo ƒë∆°n v·ªã ban h√†nh:")
    for unit, count in stats['by_unit']:
        print(f"   ‚Ä¢ {unit}: {count} vƒÉn b·∫£n")
    
    print(f"\nüìÖ Theo nƒÉm:")
    for year, count in stats['by_year']:
        print(f"   ‚Ä¢ NƒÉm {year}: {count} vƒÉn b·∫£n")


def demo_detail():
    """Demo xem chi ti·∫øt vƒÉn b·∫£n"""
    storage = ChatbotStorage()
    
    print("\n" + "="*70)
    print("üìÑ DEMO XEM CHI TI·∫æT VƒÇN B·∫¢N")
    print("="*70)
    
    # L·∫•y vƒÉn b·∫£n ID = 1
    doc = storage.get_document_by_id(1)
    
    if doc:
        print(f"\nüìå Ti√™u ƒë·ªÅ: {doc['tieu_de']}")
        print(f"üìÖ Ng√†y ban h√†nh: {doc['ngay_ban_hanh']}")
        print(f"üè¢ ƒê∆°n v·ªã: {doc['don_vi_ban_hanh']}")
        print(f"\nüìù Tr√≠ch y·∫øu:")
        print(f"   {doc['trich_yeu']}")
        print(f"\n‚≠ê N·ªôi dung quan tr·ªçng:")
        if isinstance(doc['noi_dung_quan_trong'], list):
            for i, item in enumerate(doc['noi_dung_quan_trong'], 1):
                print(f"   {i}. {item}")
    else:
        print("   ‚ùå Kh√¥ng t√¨m th·∫•y vƒÉn b·∫£n")


def demo_backup():
    """Demo backup"""
    storage = ChatbotStorage()
    
    print("\n" + "="*70)
    print("üíæ DEMO BACKUP")
    print("="*70)
    
    print("\nüîÑ ƒêang backup SQLite ‚Üí JSON...")
    count = storage.backup_to_json()
    
    print("\nüîÑ ƒêang export ‚Üí CSV...")
    storage.export_to_csv()


if __name__ == "__main__":
    print("ü§ñ CHATBOT STORAGE MANAGER")
    print("="*70)
    
    # Ch·∫°y t·∫•t c·∫£ demos
    demo_search()
    demo_statistics()
    demo_detail()
    demo_backup()
    
    print("\n" + "="*70)
    print("‚úÖ HO√ÄN T·∫§T DEMO!")
    print("="*70)
    
    print("\nüí° G·ª¢I √ù S·ª¨ D·ª§NG:")
    print("   from chatbot_storage import ChatbotStorage")
    print("   storage = ChatbotStorage()")
    print("   results = storage.search_by_keyword('h·ªçc ph√≠')")
